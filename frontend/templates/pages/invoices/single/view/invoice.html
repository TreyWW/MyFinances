{% load markdownify %}
{% load dashify contains from strfilters %}

<nav class="flex justify-between items-start mb-8">
    <aside class="flex items-center space-x-6">
        {% if invoice.logo %}
            <img src="{{ invoice.logo.url }}" alt="Company logo" class="h-20">
        {% else %}
            <img src="https://raw.githubusercontent.com/TreyWW/MyFinances/main/frontend/static/img/logo_single.png"
                 alt="Company logo" class="h-20">
        {% endif %}
        <div>
            <h1 class="text-2xl font-semibold">{{ invoice.self_company|default_if_none:invoice.self_name }}</h1>
            <p>{{ invoice.self_phone|default_if_none:"" }}</p>
            {% if invoice.vat_number %}
                <p>VAT: {{ invoice.vat_number }}</p>
            {% endif %}
        </div>
    </aside>

    <!-- Invoice details aligned to the right, labels above values, with shading -->
    <section class="text-right space-y-4">
        <div>
            <p class="text-sm text-gray-500 uppercase tracking-wide">Invoice Ref</p>
            <p>{{ invoice.invoice_id|default:invoice.id }}</p>
        </div>
        <div>
            <p class="text-sm text-gray-500 uppercase tracking-wide">Date Sent</p>
            <p>{{ invoice.date_issued|date:"d/m/Y" }}</p>
        </div>
        <div>
            <p class="text-sm text-gray-500 uppercase tracking-wide">Due By</p>
            <p>{{ invoice.date_due|date:"d/m/Y" }}</p>
        </div>
        <div>
            <p class="text-sm text-gray-500 uppercase tracking-wide">Amount Due</p>
            <p>GBP {{ invoice.get_currency_symbol }}{{ invoice.get_total_price }}</p>
        </div>
    </section>
</nav>

<main class="mb-8">
    <!-- Bill To section -->
    {% with details=invoice.get_to_details %}
        <h2 class="text-lg font-semibold mb-2">Bill To:</h2>
        {% include 'pages/invoices/single/view/_client-details.html' with c_type=details.0 c_details=details.1 %}
    {% endwith %}

    <!-- Invoice Items Table -->
    <table class="w-full text-left border-t border-b my-8">
        <thead class="bg-gray-100 text-sm uppercase">
        <tr>
            <th class="py-3 px-4">Description</th>
            <th class="py-3 px-4 text-right">Rate</th>
            <th class="py-3 px-4 text-right">QTY</th>
            <th class="py-3 px-4 text-right">Amount</th>
        </tr>
        </thead>
        <tbody class="divide-y">
        {% for item in invoice.items.all %}
            <tr>
                <td class="py-3 px-4">
                    <span class="block font-medium">{{ item.name }}</span>
                    <small class="text-gray-500">{{ item.description|markdownify }}</small>
                </td>
                <td class="py-3 px-4 text-right">{{ invoice.get_currency_symbol }}{{ item.price_per_hour }}</td>
                <td class="py-3 px-4 text-right">{{ item.hours }}</td>
                <td class="py-3 px-4 text-right">{{ invoice.get_currency_symbol }}{{ item.get_total_price|floatformat:2 }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- Invoice Summary Table Footer -->
    <div class="w-full flex justify-end">
        <table class="w-1/2 text-right">
            <tbody>
            <tr>
                <td class="py-3 pr-4">Subtotal:</td>
                <td class="py-3">{{ invoice.get_currency_symbol }}{{ invoice.get_subtotal }}</td>
            </tr>
            {% if invoice.tax %}
                <tr>
                    <td class="py-3 pr-4">Tax:</td>
                    <td class="py-3">{{ invoice.get_currency_symbol }}{{ invoice.tax }}</td>
                </tr>
            {% endif %}
            {% if invoice.discount_percentage %}
                <tr>
                    <td class="py-3 pr-4">Discount ({{ invoice.discount_percentage }}%):</td>
                    <td class="py-3">-{{ invoice.get_currency_symbol }}{{ invoice.get_percentage_amount }}</td>
                </tr>
            {% endif %}
            <tr>
                <td class="py-3 pr-4 font-semibold">Total:</td>
                <td class="py-3 font-semibold">{{ invoice.get_currency_symbol }}{{ invoice.get_total_price }}</td>
            </tr>
            </tbody>
        </table>
    </div>
</main>

<!-- Payment Details Section, labels above values with shading -->
<footer class="mt-8 flex flex-row flex-grow">
    <!-- Payment Details -->
    <div class="w-1/3 h-auto">
        <h2 class="text-lg font-semibold mb-2">Payment Details</h2>
        <div class="space-y-4">
            <div>
                <p class="text-sm text-gray-500 uppercase tracking-wide">Account Holder Name</p>
                <p>{{ invoice.account_holder_name }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 uppercase tracking-wide">Account Number</p>
                <p>{{ invoice.account_number }}</p>
            </div>
            <div>
                <p class="text-sm text-gray-500 uppercase tracking-wide">Sort Code</p>
                <p>{{ invoice.sort_code }}</p>
            </div>
        </div>
    </div>

    <!-- Notes Section -->
    {% if invoice.notes %}
    <div class="w-2/3 h-auto ml-4">
        <div class="rounded-lg" style="height: 100%;">
            <h2 class="text-lg font-semibold mb-2">Notes</h2>
            {{ invoice.notes|markdownify }}
        </div>
    </div>
    {% endif %}
</footer>


<!-- Tailwind print styles -->
<style>
    @media print {
        .break-inside-avoid {
            page-break-inside: avoid;
        }

        .page-break-inside-avoid {
            page-break-before: avoid;
            page-break-after: avoid;
        }

        table, th, td {
            page-break-inside: avoid !important;
        }

        h1, h2, h3, p {
            orphans: 3;
            widows: 3;
        }
    }
</style>
